const font = {
  "a": {
    "w": 12,
    "h": 13,
    "char": [
      "111100001111",
      "111001100111",
      "111001100111",
      "111001100111",
      "110011110011",
      "110011110011",
      "100000000001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011110011",
      "100011110001",
      "001101101100",
      ""
    ]
  },
  "b": {
    "w": 10,
    "h": 13,
    "char": [
      "0011000011",
      "1000011001",
      "1100111100",
      "1100111100",
      "1100111100",
      "1100111001",
      "1000000011",
      "1100111001",
      "1100111100",
      "1100111100",
      "1100111100",
      "1000011001",
      "0011000011",
      ""
    ]
  },
  "c": {
    "w": 9,
    "h": 13,
    "char": [
      "111000001",
      "110011100",
      "100111100",
      "100111111",
      "100111111",
      "100111111",
      "000011111",
      "100111111",
      "100111111",
      "100111100",
      "100011100",
      "110000001",
      "111000011",
      ""
    ]
  },
  "d": {
    "w": 10,
    "h": 13,
    "char": [
      "0011000011",
      "1000011001",
      "1100111100",
      "1100111100",
      "1100111100",
      "1100111100",
      "1000011000",
      "1100111100",
      "1100111100",
      "1100111100",
      "1100111100",
      "1000011001",
      "0011000011",
      ""
    ]
  },
  "e": {
    "w": 10,
    "h": 13,
    "char": [
      "0011000001",
      "1000000001",
      "1100111101",
      "1100111001",
      "1100111111",
      "1100110111",
      "1000000111",
      "1100110111",
      "1100111111",
      "1100111100",
      "1100111110",
      "1000000000",
      "0011000000",
      ""
    ]
  },
  "f": {
    "w": 9,
    "h": 13,
    "char": [
      "001100000",
      "100000000",
      "110011110",
      "110011100",
      "110011111",
      "110011011",
      "100000011",
      "110011011",
      "110011111",
      "110011111",
      "110011111",
      "100011111",
      "001101111",
      ""
    ]
  },
  "g": {
    "w": 9,
    "h": 13,
    "char": [
      "111000001",
      "110011100",
      "100111100",
      "100111111",
      "100111111",
      "100111111",
      "000011111",
      "100111000",
      "100111100",
      "100111100",
      "100011100",
      "110000001",
      "111000011",
      ""
    ]
  },
  "h": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011110011",
      "100000000001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011110011",
      "100011110001",
      "001101101100",
      ""
    ]
  },
  "i": {
    "w": 6,
    "h": 13,
    "char": [
      "001100",
      "100001",
      "110011",
      "110011",
      "110011",
      "110011",
      "100001",
      "110011",
      "110011",
      "110011",
      "110011",
      "100001",
      "001100",
      ""
    ]
  },
  "j": {
    "w": 10,
    "h": 13,
    "char": [
      "1111001100",
      "1111100001",
      "1111110011",
      "1111110011",
      "1111110011",
      "1111110011",
      "1111110011",
      "1001110011",
      "0011110011",
      "0011110011",
      "0011110011",
      "1001100011",
      "1100000111",
      ""
    ]
  },
  "k": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110011100111",
      "110011001111",
      "110010011111",
      "100000011111",
      "110011001111",
      "110011100111",
      "110011110011",
      "110011110011",
      "100011110001",
      "001101101100",
      ""
    ]
  },
  "l": {
    "w": 10,
    "h": 13,
    "char": [
      "0011001111",
      "1000011111",
      "1100111111",
      "1100111111",
      "1100111111",
      "1100111111",
      "1000011111",
      "1100111111",
      "1100111111",
      "1100111100",
      "1100111110",
      "1000000000",
      "0011000000",
      ""
    ]
  },
  "m": {
    "w": 13,
    "h": 13,
    "char": [
      "0011011101100",
      "1000111110001",
      "1100111110011",
      "1100011100011",
      "1100001000011",
      "1100100010011",
      "1000110110001",
      "1100111110011",
      "1100111110011",
      "1100111110011",
      "1100111110011",
      "1000111110001",
      "0011011101100",
      ""
    ]
  },
  "n": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110001110011",
      "110000110011",
      "110010110011",
      "100011010001",
      "110011000011",
      "110011100011",
      "110011110011",
      "110011110011",
      "100011110001",
      "001101101100",
      ""
    ]
  },
  "o": {
    "w": 11,
    "h": 13,
    "char": [
      "11100000111",
      "11001110011",
      "10011111001",
      "10011111001",
      "10011111001",
      "10011111001",
      "00001110000",
      "10011111001",
      "10011111001",
      "10011111001",
      "10011111001",
      "11001110011",
      "11100000111",
      ""
    ]
  },
  "p": {
    "w": 10,
    "h": 13,
    "char": [
      "0011000011",
      "1000011001",
      "1100111100",
      "1100111100",
      "1100111100",
      "1100110001",
      "1000000111",
      "1100111111",
      "1100111111",
      "1100111111",
      "1100111111",
      "1000011111",
      "0011001111",
      ""
    ]
  },
  "q": {
    "w": 11,
    "h": 13,
    "char": [
      "11100000111",
      "11001110011",
      "10011111001",
      "10011111001",
      "10011111001",
      "10011111001",
      "00001110000",
      "10011111001",
      "10011111001",
      "10011001001",
      "10011100001",
      "11001110011",
      "11100000101",
      ""
    ]
  },
  "r": {
    "w": 12,
    "h": 13,
    "char": [
      "001100001111",
      "100001100111",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011000111",
      "100000011111",
      "110011001111",
      "110011100111",
      "110011110011",
      "110011110011",
      "100001110001",
      "001100101100",
      ""
    ]
  },
  "s": {
    "w": 9,
    "h": 13,
    "char": [
      "111000011",
      "110011001",
      "100111100",
      "100111000",
      "100111111",
      "110011111",
      "111000011",
      "111111001",
      "111111100",
      "000011100",
      "100111100",
      "110011001",
      "111000011",
      ""
    ]
  },
  "t": {
    "w": 10,
    "h": 13,
    "char": [
      "1000000001",
      "0000000000",
      "0111001110",
      "0011001100",
      "1111001111",
      "1111001111",
      "1110000111",
      "1111001111",
      "1111001111",
      "1111001111",
      "1111001111",
      "1110000111",
      "1100110011",
      ""
    ]
  },
  "u": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011110011",
      "100001100001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110011110011",
      "110001100011",
      "111000000111",
      ""
    ]
  },
  "v": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110011110011",
      "110011110011",
      "110001100011",
      "111001100111",
      "111001100111",
      "111001100111",
      "111101101111",
      "111100001111",
      "111110011111",
      "111110011111",
      ""
    ]
  },
  "w": {
    "w": 13,
    "h": 13,
    "char": [
      "0011011101100",
      "1000111110001",
      "1100111110011",
      "1100111110011",
      "1100111110011",
      "1100111110011",
      "1100011100011",
      "1110010100111",
      "1110010100111",
      "1110000000111",
      "1110001000111",
      "1110011100111",
      "1110111110111",
      ""
    ]
  },
  "x": {
    "w": 12,
    "h": 13,
    "char": [
      "001101101100",
      "100011110001",
      "110011110011",
      "110001100011",
      "111001100111",
      "111100001111",
      "111110011111",
      "111100001111",
      "111001100111",
      "110001100011",
      "110011110011",
      "100011110001",
      "001101101100",
      ""
    ]
  },
  "y": {
    "w": 10,
    "h": 13,
    "char": [
      "0010110100",
      "1001111001",
      "1001111001",
      "1100110011",
      "1100110011",
      "1110000111",
      "1110000111",
      "1111001111",
      "1111001111",
      "1111001111",
      "1111001111",
      "1110000111",
      "1100110011",
      ""
    ]
  },
  "z": {
    "w": 10,
    "h": 13,
    "char": [
      "1000001100",
      "1000000001",
      "1011110011",
      "1001110011",
      "1111100111",
      "1111100111",
      "1100000011",
      "1110011111",
      "1110011111",
      "1100111100",
      "1100111110",
      "1000000000",
      "0011000000",
      ""
    ]
  }
};

class ParticleSystem {
  constructor() {
    this.particles = [];
    this.prevParticles = [];
    this.forceAccumulators = [];
    this.constraints = [];
    this.fixedParticles = [];
    this.gravity = [0, 0.6];
  }

  verlet(dt) {
    for (let i = 0; i < this.particles.length; i++) {
      const p = this.particles[i];
      const prevp = this.prevParticles[i];
      const force = this.forceAccumulators[i];
      const newp = [0, 0];
      newp[0] = p[0] + (p[0] - prevp[0]) + force[0] * dt * dt;
      newp[1] = p[1] + (p[1] - prevp[1]) + force[1] * dt * dt;
      this.particles[i] = newp;
      this.prevParticles[i] = p;
    }
  }

  accumulateForces() {
    for (let i = 0; i < this.particles.length; i++) {
      // this.forceAccumulators[i][0] = this.gravity[0];
      this.forceAccumulators[i][1] = this.gravity[1];
    }
  }

  satisfyConstraints() {
    const iterations = 5;
    for (let j = 0; j < iterations; j++) {
      for (let i = 0; i < this.constraints.length; i++) {
        const [ida, idb, len] = this.constraints[i];
        const pa = this.particles[ida];
        const pb = this.particles[idb];
        const delta = [pb[0] - pa[0], pb[1] - pa[1]];
        const deltaLength = Math.sqrt(delta[0] * delta[0] + delta[1] * delta[1]);
        const diff = (deltaLength - len) / deltaLength;
        pa[0] += delta[0] * 0.6 * diff;
        pa[1] += delta[1] * 0.6 * diff;
        pb[0] -= delta[0] * 0.6 * diff;
        pb[1] -= delta[1] * 0.6 * diff;
      }

      for (const particle of this.fixedParticles) {
        const [id, x, y] = particle;
        this.particles[id] = [x, y];
      }
    }
  }

  step(dt) {
    this.accumulateForces();
    this.verlet(dt);
    this.satisfyConstraints();
  }

  add(x, y, fx = 0, fy = 0) {
    this.particles.push([x, y]);
    const i = this.particles.length - 1;
    this.prevParticles[i] = [x, y];
    this.forceAccumulators[i] = [fx, fy];
    return i;
  }

  fix(id, x, y) {
    if (typeof x === 'undefined') {
      const p = this.particles[id];
      this.fixedParticles.push([id, p[0], p[1]]);
    } else {
      this.fixedParticles.push([id, x, y]);
    }
  }

  unfix(id) {
    this.fixedParticles = this.fixedParticles.filter(p => p[0] !== id);
  }

  addConstraint(ida, idb, len) {
    this.constraints.push([ida, idb, len]);
  }
}

const { loadImage, createCanvas } = require('canvas');

function crochet(text) {
  const canvas = createCanvas(1000, 480);
  const ctx = canvas.getContext('2d');

  let psim = new ParticleSystem();
  let edges = {};
  let dragPoint = null;

  function getLetter(l) {
    if (font[l.toLowerCase()]) {
      return font[l.toLowerCase()];
    }
    return {
      w: 4,
      h: 13,
      char: [],
    };
  }

  function makeGrid(text, space) {
    const margin = 2;
    let w = text.split('').reduce((acc, l) => acc + getLetter(l).w, 0) + text.length + margin * 2;
    if (w % 2 === 0) {
      w++;
    }
    let h = font['s'].h + 1 + margin * 2;
    if (h % 2 === 0) {
      h++;
    }

    // add points
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        let px = x * space;
        let py = y * space;

        // wiggle the edges a lil
        // if ((x === 0 || x === w - 1 || y === 0 || y === h - 1)) {
          // const wiggle = 8;
          // px += Math.floor(Math.random() * wiggle - (wiggle/2));
          // py += Math.floor(Math.random() * wiggle - (wiggle/2));
        // }

        const id = psim.add(px, py);

        if (x === Math.floor(w/2) && y === h - 2) {
          dragPoint = id;
        }
      }
    }

    // add grid constraints
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        const id = x + y * w;
        if (x > 0)
          psim.addConstraint(id - 1, id, space);
        if (y > 0)
          psim.addConstraint(id - w, id, space);
      }
    }

    // add fancy edges
    const fancySpace = space / 3;

    // vertical
    for (let x = 0; x < w; x++) {
      if (x % 2 === 1) {
        let prevTop = null;
        let prevBottom = null;
        for (let i = 0; i < 6; i++) {
          const px = Math.cos(Math.PI * (i + 1)/7) * space;
          const py = Math.sin(Math.PI * (i + 1)/7) * space;

          // top
          const top = psim.add(x * space + px, 0 - py);
          psim.fix(top);
          psim.addConstraint(x, top, space);

          if (prevTop) {
            psim.addConstraint(prevTop, top, fancySpace);
          }
          if (i === 0) {
            psim.addConstraint(x + 1, top, fancySpace);
          }
          if (i === 5) {
            psim.addConstraint(x - 1, top, fancySpace);
          }
          prevTop = top;

          // bottom
          const bottom = psim.add(x * space + px, (h - 1) * space + py);
          psim.fix(bottom);
          psim.addConstraint(x + (h - 1) * w, bottom, space);

          if (prevBottom) {
            psim.addConstraint(prevBottom, bottom, fancySpace);
          }
          if (i === 0) {
            psim.addConstraint(x + 1 + (h - 1) * w, bottom, fancySpace);
          }
          if (i === 5) {
            psim.addConstraint(x - 1 + (h - 1) * w, bottom, fancySpace);
          }
          prevBottom = bottom;
        }
      }
    }

    // horizontal
    for (let y = 0; y < h; y++) {
      if (y % 2 === 1) {
        let prevLeft = null;
        let prevRight = null;
        for (let i = 0; i < 6; i++) {
          const px = Math.sin(Math.PI * (i + 1)/7) * space;
          const py = Math.cos(Math.PI * (i + 1)/7) * space;

          // left
          const left = psim.add(0 - px, y * space + py);
          psim.fix(left);
          psim.addConstraint(y * w, left, space);

          if (prevLeft) {
            psim.addConstraint(prevLeft, left, fancySpace);
          }
          if (i === 0) {
            psim.addConstraint((y + 1) * w, left, fancySpace);
          }
          if (i === 5) {
            psim.addConstraint((y - 1) * w, left, fancySpace);
          }
          prevLeft = left;

          // right
          const right = psim.add((w - 1) * space + px, y * space + py);
          psim.fix(right);
          psim.addConstraint((y + 1) * w - 1, right, space);

          if (prevRight) {
            psim.addConstraint(prevRight, right, fancySpace);
          }
          if (i === 0) {
            psim.addConstraint((y + 2) * w - 1, right, space);
          }
          if (i === 5) {
            psim.addConstraint(y * w - 1, right, space);
          }
          prevRight = right;
        }
      }
    }

    // fix the edges
    const minx = psim.particles.reduce((min, p) => p[0] < min ? p[0] : min, Infinity);
    const maxx = psim.particles.reduce((max, p) => p[0] > max ? p[0] : max, -Infinity);
    const miny = psim.particles.reduce((min, p) => p[1] < min ? p[1] : min, Infinity);
    const maxy = psim.particles.reduce((max, p) => p[1] > max ? p[1] : max, -Infinity);

    for (let i = 0; i < psim.particles.length; i++) {
      const p = psim.particles[i];
      if (p[0] === minx || p[0] === maxx || p[1] === miny || p[1] === maxy) {
        psim.fix(i);
      }
    }

    // add filled letter constraints
    let xoffset = margin;
    let yoffset = margin;
    const diagonalSpace = Math.sqrt(space * space + space * space) * 0.9;
    for (const letter of text.split('')) {
      const f = getLetter(letter);
      if (f.char.length === 0) {
        xoffset += f.w + 1;
        continue;
      }

      for (let y = 0; y < f.h; y++) {
        for (let x = 0; x < f.w; x++) {
          if (f.char[y][x] === '0') {
            const id = x + xoffset + (y + yoffset) * w;
            psim.addConstraint(id + w + 1, id, diagonalSpace);
            psim.addConstraint(id + w, id + 1, diagonalSpace);
          }
        }
      }

      xoffset += f.w + 1;
    }

    return [w, h];
  }

  const cellSize = 12;
  const padding = 3;
  let w = 0;
  let h = 0;
  let fixedParticles = [];

  function reset(text) {
    psim = new ParticleSystem();
    edges = {};
    [w, h] = makeGrid(text, cellSize);
    canvas.width = w * cellSize + (padding * cellSize);
    canvas.height = h * cellSize + (padding * cellSize);
    fixedParticles = [...psim.fixedParticles];
  }

  function drawCrochet(psim, ctx) {
    for (const constraint of psim.constraints) {
      const [ida, idb, len] = constraint;
      const pa = psim.particles[ida];
      const pb = psim.particles[idb];
      ctx.lineWidth = 3;

      // if (edges[ida] && edges[idb]) {
      //   ctx.lineWidth = 7;
      // }

      ctx.beginPath();
      ctx.moveTo(pa[0], pa[1]);
      ctx.lineTo(pb[0], pb[1]);
      ctx.stroke();
    }
  }

  reset(text.slice(0, 50));

  psim.fixedParticles = fixedParticles;
  psim.step(1);

  ctx.translate(padding/2 * cellSize, padding/2 * cellSize);

  ctx.lineCap = 'round';
  ctx.strokeStyle = 'rgb(240, 224, 210)';
  drawCrochet(psim, ctx);

  const buf =  canvas.toBuffer('image/png');
  return { data: buf, ext: 'png' };
}

commands = { crochet };
